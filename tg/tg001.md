```
TG: 001
Title: Implementation guide for payment providers
Author: Mike Gaertner <gaertner.mike@sabay.com>, Owen Jacob <jacob.owen@sabay.com>
Status: Active
Created: 2019-08-25
Updated: 2020-02-28
Version 2.0.0
```

Implementation guide for payment providers
==========================================

This document describes the account setup and API implementation required to be completed by payment providers who wish to integrate with SSN.

# SSN account setup

This is a one time process although payment providers may wish to complete it programmatically so that the setup can be stored in version control for future reference. The following documents provide information on correctly setting up SSN accounts:

* Account settings [TR001](/tr/tr001.md)
* KYC settings [TR006](/tr/tr006.md)

# Implementation of a payment provider API on SSN

## Status and Info endpoints

These endpoints can be used to determine the status of the payment provider's SSN API. The endpoint designs are documented here: [status](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/info/get_status) and [info](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/info/getInfo).

## One time payments

One time payments are where the payment provider prompts the user for payment authorization for each transaction.

### One time payments flow

The endpoint design is documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Provider%20API#/payments/post_charge_onetime__payment_address_).

#### Step 1 - Verify the requst signature is valid

The payment provider should take the full request URL, sha256 hash the url and encode the result in hex to compare to the request hash (examples [here](tg/tg006.md#creating-messages)). The SSN API can then be used to verify the signature using the endpoint documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/verify/post_verify_signature). A HTTP 200 response indicates the signature is valid.

#### Step 2 - Resolve the payment address

The payment provider should prepare the request to the payment address resolver as documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20Payment%20Address%20Resolver%20APIv2#/resolver/post_resolve__payment_address_). The resolver response will provide the payment provider with information to complete the transaction. There are several possible responses that should inform the payment provider's next step before completing the payment:

If the payment array:
* Contains only a single object with just an asset_code present -> the payment provider should prompt the user for an amount in that currency.
* Contains multiple objects with just asset_codes present -> the payment provider should prompt the user for an amount and the currency they wish to pay in.
* Contains only a single object with an asset_code and an amount present -> the payment provider should prompt the user to confirm the payment amount and currency.
* Contains multiple objects with asset_codes and amounts present -> the payment provider should prompt the user to confirm the payment amount and choose which currency they wish to pay in

#### Step 3 - Optionally check the trustline is valid

The resolver for the payment address should already have checked a trustline was in place but the payment provider can ensure this by also checking the trustline using the endpoint [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/verify/post_verify_trust).

#### Step 4 - User authorizes the payment; Payment provider moves the amount to escrow

The payment provider's usual payment authorization options can be used here. Once the user has authorized the payment the payment provider should move the funds from the users account to an escrow account that holds SSN funds at the payment provider.

#### Step 5 - Build and Sign the payment for SSN

Using the information from the resolved payment address along with the users input the payment provider can use the endpoint documented [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/transactions/post_create_transaction) to build a payment transaction for SSN. The transaction should be signed by the payment provider key(s) and then submitted to the endpoint [here](https://api-reference.ssn.digital/?urls.primaryName=SSN%20API#/transactions/post_transactions). The response of the transaction endpoint will include the network ledger number and the network transaction hash provided the transaction was sucessfully accepted.

If a redirect URL was provided in the original request the payment provider should redirect to that URL with the transaction hash otherwise the payment provider can show the user a success screen along with the hash for the users records.

## Pre-authorized payments

Pre-authorized payments are where the payment provider prompts the user for authorization once and then a merchant is able to pull transactions. The payment provider can optionally prompt the user for transaction limits.

### Adding Pre-authorized charging permission

### Pre-authorized charging flow

### Deleting Pre-authorized charging permission

# Implementation of a payment provider settlement service






# Nomenclature

**Payment Providers** on SSN are asset issuing accounts, representing a payment provider which backs the assets issued via a FIAT reserve, and is licensed to hold money in escrow for user.

**Tokens** are IOU's (I Owe yoU), refers to an asset issued on SSN by payment providers

**Assets** are tokens on SSN identified by an asset_code and asset_issuer.

**Accounts** are electronic wallets which can issue and hold tokens. Accounts are identified by a public key, see also *network address*

**Payment Address** an address which describes a payment destination (ex. invoice*service.example), the address must be resolved into a network address for a transaction on SSN , payment address encode service specific information for routing a payment to the correct account at the merchant or service provider.

**Network Address** are address describing an account on SSN using the public key of the account. *ex. GBIUFPAZAQDUI4U7E4476ARDWYCVAVUE7U7FRMRBQ72D6BRU6JYOVY43*

**Transactions** are operations on accounts, the operation can be between several accounts e.g. a transaction transferring tokens, or a transaction can be used to change settings on one account

**SSN Keys** are keys to sign transactions and to identify accounts (network address), each key comprises of a public key and a secret key. 

**Public Key** is used to identify accounts and authorized signers, a public key can be shared, several public keys (with different access authority) can be added to an account to sign transactions and/or change account settings

**Secret Key** is used to sign transactions which perform operations on SSN, secret keys should never be shared with anyone.

**Trustline** is a setting on an account to trust an asset issued by a cashier, only when an account trusts an asset, can the account hold this asset.

**Trust Line Authorization Required** requires that the issuing account approves a Trustline before the receiving account is allowed to be paid with the asset.

**Settlement Provider** is a service provider on SSN for settling balances between merchants and payment provider 




# Introduction to payment providers

Payment providers on SSN 

* provide payment services to merchants 
* by authorizing a payment request with a user

and 

* recording the authorization on SSN 
* by issuing tokens on SSN which represent the payment. 

Tokens are a digital assets which are identified by the asset name (e.g. USD represents a USD backed asset) and the asset issuer (e.g. the institution which backs the asset with a underlying reserve). Each token issued is uniquely linked to a asset issuing account. Once the tokens are returned to that account, the tokens are destroyed. 

Payment providers sign the digital token creation on SSN via their own secret key, cryptographically verifying and securing the origin of the tokens.

Tokens must be backed by an underlying FIAT reserve held in escrow with the cashier. Payment providers are responsible to redeem tokens for the underlying FIAT asset at the agreed rate with a settlement provider when the tokens are returned to the cashier.

**Once a payment authorization is recorded, it is immutable.** It can not be changed, reversed or removed.

A Payment provider can be a bank, a 3rd party payment processor, a mobile wallet provider or mobile carrier. All payment providers operating on SSN are listed in the asset directory under the cashier.ssn.digital domain.

Merchants on SSN, must apply to the payment provider and be accepted by the payment provider for merchant payments.

During the payment process, the payment providers must deduct the amount from the user balance and hold it in escrow until settlement with either the merchant directly or a settlement provider. When tokens are returned to the asset issuing account, the payment provider must exchange them for the underlying fiat asset, minus fees and commissions. 

***Payment providers must publish the rate at with they will exchange the tokens issued for the underlying FIAT asset and may not settle below this rate.*** 

The rate must be published using the data file ````net_payout``` on the asset issuing account e.g.

```
net_payout=0.9975
```

This would denoted that for every 1 token returned to the payment provider, the merchant can expect to get paid 99.75% of the face value in the underlying FIAT currency.

The process for a payment provider involves the following steps upon receiving a payment request:

* verify the user
* resolve the payment address to get payment details (or scan QR code)
* use internal systems to deduct the users funds and moves them to an escrow account
* issue a transaction to SSN
* inform user of the transaction success with the SSN transaction hash

# Types of cashiers

A payment provider can implement different types of payment services on SSN:

* merchant payment
* bill payment

Merchant payments; usually the merchant is paying a small fee for the service. Bill payments; the full amount must be settled and the user will pay a fee for the payment.

Payment providers who want to offer both services should setup 2 asset issuing accounts, with different ```net_payout``` configurations for the service and approve merchants depending on agreements between merchant and payment provider.

SSN supports the following method to signal payment details from the merchant to the payment provider:

* onetime payments (merchant initiated)
* pre-authorized payments (merchant initiated)
* direct payments (user initiated)





# Incoming transactions to the payment providers accounts

A payment providers account must be able to process incoming transactions for 

1) settlement with merchant
2) refunds to user account
3) rejected payments

The settlement process is described in more detail in TR004 [Settlement on SSN](../tr/tr004.md). 

When the payment provider receives a incoming transaction he should verify first if the transaction memo is a hash or a text string. If the memo type is a hash then the incoming transaction is a rejected transaction by a merchant. If the memo type is text and the memo contains a valid account number at the payment providers system, then the transaction should be processed as settlement or refund.

## Rejected transactions

If a merchant receives a payment which cannot be processed or where the user has canceled the order after the payment was made, the merchant can reject the payment by reversing the transaction. Rejects are implemented by sending the received amount back to the originating sender address and referencing the original transaction hash in the memo field.

The payment provider needs to process the refund by 

* checking the transaction hash in the memo
* finding the original transaction details
* refunding the amount to the users account
* notifying the user about the refund

No fees should be charged for the refund transaction. The merchant has to pay the network fees for the refund transaction.

## Settlement or refunds

When the merchant want to redeem tokens to his account, or make a partial refund to a user, the merchant will construct a transaction on SSN to return payment providers tokens to the asset issuing account, with a memo containing a valid using account (the ISO 13616:2007 standard for International Bank Account Number) for the payment providers (e.g. bank account or wallet account number).

The payment provider needs to process the transaction by:

* checking the account number in the memo
* deducting commissions and fees 
* crediting from escrow the amount due to the users account
* notifying the user about within its eco system
