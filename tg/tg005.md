```
TG: 005
Title: PIN less top-up for mySabay accounts
Author: Mike Gaertner <gaertner.mike@sabay.com>
Status: Active
Created: 2019-11-07
Updated: 2020-01-21
Version 1.2.1
```

PIN less top-up for mySabay accounts
====================================

This guide describes how to implement PIN less top-up for mySabay accounts. 

This guide is using the direct payment workflow where customers are entering their customer details with the payment provider and the payment provider will execute a payment to the merchant using SSN. Payment Providers do not need to provision any API for this service.

# About mySabay

mySabay is a platform used by players to manage game accounts and top-up game coins for games offered by Sabay Digital and its partners. Players can either top-up their mySabay account or transfer money into individual games directly. In this workflow the player will top-up his mySabay account.

# Pre-requisite 

* Merchant agreement with Sabay Digital 
* Settlement agreement with SSN
* Understanding of the Stellar Blockchain (basic principals) https://stellar.org
* understanding of making transactions on SSN (using SDK's provided by Stellar or 3rd parties)

## More information

* https://github.com/sabay-digital/org.ssn.doc.public public library for all documents related to SSN published by Sabay
* https://api-reference.ssn.digital/ API reference for all API's used by SSN
* https://www.stellar.org/developers/guides/get-started/index.html documentation from the SDF
* https://www.stellar.org/developers/horizon/reference/ REST API documentation for Horizon, the API endpoint used by SSN to access the blockchain

## Tools to use for SSN 

* https://t.me/ssn_digital join the SSN telegram group, the group bot can seed your test account
* https://lab.ssn.digital blockchain lab from SDF
* https://explorer.master.ssn.digital blockchain explorer from Sabay
* https://api.testing.ssn.digital Testing network Blockchain API endpoint
* Testing Network Passphrase: ssn_testing_network

NOTE: The horizon endpoint https://horizon.testing.ssn.digital can still be use in the testing network. Access in the production network will only be via the API endpoint https://api.ssn.digital. If you find a function in your SDK which does not work with API but works with Horizon endpoint, please inform us.

## Libraries used

* stellar sdk, see section libraries on https://www.stellar.org/developers/horizon/reference/

The library has implementations in all major programming languages. 

## Setup on the test network

1) create a key pair using the blockchain lab https://lab.ssn.digital/
2) join SSN telegram group and open an account using your public key and the group chat bot (/help)
3) setup your account as payment provider account (permissions and KYC)
4) request our team to apply for a trustline to your account
5) Accept trust for Sabay Digital's "mySabay user account top-up" account for the asset 

The mySabay top-up account is ```GBNV4PMFUTPYRKVQZV7V47W46KGZLKK5GWVAEXYPS7QJVQWY4B6X43JS``` on the testing network and production network.

Configure your account:
* Account setting [TR001](../tr/tr001.md)
* KYC settings [TR006](../tr/tr006.md)

## Setup your SSN toml configuration

In order for the network to discover what assets you offer and where to connect to your API, digital asset issuers are required to publish a SSN toml file [TR007](../tr/tr007.md). For direct payments there is no need to call a API from the merchant site, however the merchant may access your SSN configuration to determine the currency for the payment.

* set your accounts home_domain
* upload your toml file and define the assets you want to offer (USD, KHR) 

The key pair used on the test network can also be used on the production network. The toml file in this case can be served from the final production setup.

# Workflow for direct top-up

Flow for a direct PIN less top-up to a mySabay account

1) request mySabay userID from your customer and create the payment address
2) query the payment address federated domain for the ssn.toml configuration and resolve the address
3) ask the customer for the top-up amount and currency
4) build and submit the transaction on SSN

## Step 1

Within your application (web or mobile) ask the user to input his mySabay userID. The mySabay userID is a 8 digit number e.g. ```37837941```. Sabay is using the federated domain ```mysabay.com``` (or ```testing.mysabay.com``` in testing) as domain part of the payment address.

The payment address for mySabay follows the format ```[mysabay_user_id]:[payment_amount]:[payment_currency]*mysabay.com```. The payment provider should ask the user for their mySabay account ID and the amount and currency they wish to topup and then construct the payment address. An example payment address on the test network could be ```37837941:5:USD*testing.mysabay.com``` for a user wishing to topup their mySabay account by 5 USD. 

The payment address maybe constructed differently by each service provider, but it must always follow the same principal: left side of the (*) is the unique identifier used within the merchant system and the right side is the home domain of the merchant.

For merchants who use the static resolver the domain is always ```ssn.digital```.

## Step 2

To resolve a payment address, the provider can use the domain part of the payment address to find the configuration file for the domain. The configuration file must be hosted (same as the payment provider ssn.toml) at the well-know location:

```
https://DOMAIN/.well-known/ssn.toml
https://testing.mysabay.com/.well-known/ssn.toml
```

The merchant must define a valid payment address resolver using the following attribute: 

```
FEDERATION_SERVER="https://pa.ssn.digital/v1/
```

The payment address resolver is implement using the following API [SSN Payment Address Resolver](https://api-reference.ssn.digital/?urls.primaryName=SSN%20payment%20address%20resolver%20API) and returns a simple json object with the payment routing information to be used to build the transaction. The return for mySabay will not contain the payment amount or currency.

```bash
curl -X POST "https://pa.ssn.digital/v1/" \
  -H "accept: application/json" \
  -H "Content-Type: application/json" \
  -d "{\
        \"payment_address\" : \"37837941:5:USD*testing.mysabay.com\"}"
```

response

```json
 {
  "network_address": "GBNV4PMFUTPYRKVQZV7V47W46KGZLKK5GWVAEXYPS7QJVQWY4B6X43JS",
  "payment_type": "merchant",
  "service_name": "mySabay Top-up",
  "details": {
    "payment_info": "Service Top-UP",
    "memo": "37837941",
    "payment": {
      "amount": "5",
      "asset_code": "USD"
    }
  },
  "status": 200
}
```

## Step 3

In case the payment provider issues multiple currencies (USD, KHR) the payment provider must check for which asset (currency) Sabay has established trustlines for. *Each asset issued on SSN needs a separate trustline and approval from the payment provider and merchant.*

You can check the status for all your assets using the ```3rd party API``` on SSN and the /verify/trust/ endpoint.

```bash
curl -X POST "https://api.testing.ssn.digital/v1/verify/trust" \
    -H "accept: application/json" \
    -H "Content-Type: application/json"  \
    -d "{\
        \"account\"      : \"GBNV4PMFUTPYRKVQZV7V47W46KGZLKK5GWVAEXYPS7QJVQWY4B6X43JS\", \
        \"asset_code\"   : \"USD\", \
        \"asset_issuer\" : \"GBIUFPAZAQDUI4U7E4476ARDWYCVAVUE7U7FRMRBQ72D6BRU6JYOVY43\"}"
```
response

```json
{
    "status":200,
    "title":"asset will be accepted by account"
}
```

## Step 4

**Before submitting the transaction to the network, you need to ensure you deduct the amount from the balance of the user and transfer it to the escrow account for assets issued to SSN.**

The transaction should be build with the transaction builder API as documented in the ```3rd party API```. The resolver result maps to the API call as follows

| PA return | API call | value
| --- | --- | ---
|  | from | sender account (in most cases same as asset issuer)
| network_address | to | address of the merchant on SSN
|  | amount | Amount to pay
| memo | memo | Merchant defined memo (not to be altered)
|  | asset_code | USD or KHR 
|  | asset_issuer | Asset issuing account of the provider


```bash
curl -X POST "https://api.testing.ssn.digital/v1/create/transaction" \
    -H "accept: application/json" \
    -H "Content-Type: application/json" \
    -d "{\
        \"from\"         : \"GBIUFPAZAQDUI4U7E4476ARDWYCVAVUE7U7FRMRBQ72D6BRU6JYOVY43\", \
        \"to\"           : \"GBNV4PMFUTPYRKVQZV7V47W46KGZLKK5GWVAEXYPS7QJVQWY4B6X43JS\", \
        \"amount\"       : \"5\", \
        \"memo\"         : \"37837941\", \
        \"asset_code\"   : \"USD\", \
        \"asset_issuer\" : \"GBIUFPAZAQDUI4U7E4476ARDWYCVAVUE7U7FRMRBQ72D6BRU6JYOVY43\"}"
```
response

```json
{
    "status":200,
    "envelope_xdr":"AAAAACB+baVTd4GY.....Oa0XKT0izzArSDaCPtbAzc9FAw=="
}
```

The API will return a transaction envelop in the XDR format. The transaction is time bound and must be submitted within the next 300 seconds. The transaction can then be loaded into the SDK, signed by a authorized key for the ```from``` account and submitted to the network.

Python code example:

```python
from stellar_sdk import Server, TransactionBuilder, Signer, Network, Keypair
import sys

XDR = sys.argv[1]
SIGN_KP = Keypair.from_seed( 'SECRET_KEY_FOR_PROVIDER' )

server = Server(horizon_url="https://api.testing.ssn.digital")
transaction = TransactionBuilder.from_xdr(xdr=XDR, network_id= 'ssn_testing_network' )
transaction.sign(SIGN_KP)
response = server.submit_transaction(transaction)
```

Java code example (The imported library can be found [here](https://github.com/stellar/java-stellar-sdk/releases)):

```java
import org.stellar.sdk.*;

public class App {
    public static void main(String[] args) {
        // Load the signing keypair for the asset issuing account
        KeyPair signer = KeyPair.fromSecretSeed("SAPIAQNGL6LMP4PQK5KKZ3WEAGINLVSCKUJF75UCRCFEGUHZSNHPSEYD");
        System.out.println(signer.getAccountId());

        // This is the transaction envelope from the /create/transaction API endpoint
        String xdr = "AAAAACGOxK6XxI1TGH+7YN/KUrZN2+0A57cYnS6P0qOB/ornAcnDgAAQNwYAAAABAAAAAQAAAAAAAAAAAAAAAF4nxbIAAAABAAAABHRlc3QAAAADAAAAAQAAAAAjfCQ7zRPxthMdsE6+zt99l1x682Ccvez4hgg/uH2BYwAAAAEAAAAAmxxCL9TrB+vwqVUSTX2Sgf4gUjTgpUNXYMUQazefEykAAAABVVNEAAAAAAAjfCQ7zRPxthMdsE6+zt99l1x682Ccvez4hgg/uH2BYwAAAAAF9eEAAAAAAQAAAAAjfCQ7zRPxthMdsE6+zt99l1x682Ccvez4hgg/uH2BYwAAAAEAAAAASe1RisemqyAxGXgG+m1QgJ8ar6PqNkqCCgUKS+dA6z0AAAAAAAAAAAB6EgAAAAABAAAAAILJlLzmzyCxo84O/oLxtjFl0OUsn/jDi4JWudE5VlBDAAAAAQAAAAAhjsSul8SNUxh/u2DfylK2TdvtAOe3GJ0uj9Kjgf6K5wAAAAAAAAAXSHboAAAAAAAAAAADgf6K5wAAAEAYutHJfXExifgNQj4rU1Ohbvp4AVzhW+fTJdg/Bu07Gp1X+SzDEOcr+oRbhCsHqP0ITunSCgk6IS3oMZf6qiwAq/uGUwAAAEDjedpawFHVB65tyLX6xCZLCepWpEwqKT0jzFdqofAaOKLz7Y3qTUUM8Tu1DsZPMsMDi5Ea0P0I+lGcvwZZ31oLThH4nQAAAEB0P0e0movvhK4v4HPwh3M2mMWU+U7BXe2KWYxE2qIqbYm8h8Ddr/6pQ9066RzYRuVibV53vFdvZJPvZyh0jfEB";

        // Set the network name - ssn_testing_network or ssn_production_network
        Network testnet = new Network("ssn_testing_network");
        try {
            // Load the transaction
            Transaction payment = Transaction.fromEnvelopeXdr(xdr, testnet);

            // Sign
            payment.sign(signer);

            // Show the signed result that can be submitted to the /transactions API endpoint
            System.out.println(payment.toEnvelopeXdrBase64());
        } catch (Exception e) {
            System.out.println("Something went wrong");
        }
    }
}
```

The Network API will fail instantly if the transaction is not in order, e.g. missing signatures, no trustlines or out of submission time window.

The API will return a json object with the transaction details (on success), the transaction may take up to 5 seconds to be included in the next ledger. Should the connection be closed without receiving the response, you can query your account for the last transaction.

```json
{
  "_links": {
    "transaction": {
      "href": "https://horizon.ssn.digital/transactions/6d877ba0bb5d899e415c59bb9f90b83898b3ab2287cf93299cbb39fc09f28c95"
    }
  },
  "hash": "6d877ba0bb5d899e415c59bb9f90b83898b3ab2287cf93299cbb39fc09f28c95",
  "ledger": 1973255,
  "envelope_xdr": "AAAAAJVkSQrzv.....AAAAAAAAAAAAAFAAAAAAAAAAA=",
  "result_meta_xdr": "AAAAAQAAAAIAAAADAB4cBwAAA.....AMgAAAAAAAAAA"
}
```

In case of an error while validating the transaction, the API returns instantly with an error:

```json
{
  "type": "https://stellar.org/horizon-errors/transaction_malformed",
  "title": "Transaction Malformed",
  "status": 400,
  "detail": "Horizon could not decode the transaction envelope in this request. A transaction should be an XDR TransactionEnvelope struct encoded using base64.  The envelope read from this request is echoed in the `extras.envelope_xdr` field of this response for your convenience.",
  "extras": {
    "envelope_xdr": "AAAAAJVkSQrzvgJpDRNjm1HY1KOL.....ya6upe3E+QPz1mXiQwRD4uxOIZqcSlc"
  }
}
```

An error always means the transaction as submitted is invalid and needs to be rebuild before submitting it again. Errors are documented in the [REST API documentation](https://www.stellar.org/developers/horizon/reference/) as published by the SDF .

The ```transaction hash``` should be stored with the payment providers records, and shown as prove of the success to the user on demand. The transaction hash is visible and stored with the mySabay receiver and can be used by customer service to validate the transaction. SSN also provides a public endpoint to validate the transaction using the transaction hash.

